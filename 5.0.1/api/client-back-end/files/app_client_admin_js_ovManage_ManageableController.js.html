<!DOCTYPE html>
<html lang="en" class="yui-overrride">
<head>
    <meta charset="utf-8">
    <title>app/client/admin/js/ovManage/ManageableController.js - OpenVeo Manage AngularJS back end</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1 class="blue-main-title">OpenVeo Manage AngularJS back end</h1>
        </div>
        <div class="yui3-u-1-4 version project-version">
            API Docs for: 5.0.1
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ManageDeviceFactory.html">ManageDeviceFactory</a></li>
                                <li><a href="../classes/ManageFactory.html">ManageFactory</a></li>
                                <li><a href="../classes/ManageGroupFactory.html">ManageGroupFactory</a></li>
                                <li><a href="../classes/ManageMainController.html">ManageMainController</a></li>
                                <li><a href="../classes/ManageManageableController.html">ManageManageableController</a></li>
                                <li><a href="../classes/ManageManageableDetailController.html">ManageManageableDetailController</a></li>
                                <li><a href="../classes/ManageManageableFactory.html">ManageManageableFactory</a></li>
                                <li><a href="../classes/ovManageSortTable.html">ovManageSortTable</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ov.manage.html">ov.manage</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app/client/admin/js/ovManage/ManageableController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

/* global interact */
(function(app) {

  /**
   * @module ov.manage
   */

  /**
   * Controls the view responsible of a list of manageables.
   *
   * @class ManageManageableController
   * @static
   */
  function ManageableController(
    $q,
    $scope,
    $rootScope,
    $filter,
    $timeout,
    $location,
    $element,
    ManageFactory,
    GroupFactory,
    DeviceFactory,
    entityService,
    MANAGE_NAME,
    MANAGE_DEVICE_STATES) {
    var self = this;

    /**
     * Indicates if a drag &amp; drop is on the move.
     *
     * @property currentlyDragging
     * @type Boolean
     */
    self.currentlyDragging = false;

    /**
     * Defines an ui-state for a manageable.
     *
     * @method addUiState
     * @private
     * @param {HTMLElement} target The target manageable
     * @param {String} uiState The ui-state to set for the manageable
     */
    function addUiState(target, uiState) {
      var element = (angular.element(target).scope().$parent.device) ?
        angular.element(target).scope().$parent.device : angular.element(target).scope().group;

      if (!element[&#x27;ui-state&#x27;]) {
        element[&#x27;ui-state&#x27;] = [];
      }
      element[&#x27;ui-state&#x27;].push(uiState);
      $scope.$apply();
    }

    /**
     * Removes an ui-state for a manageable.
     *
     * @method removeUiState
     * @private
     * @param {HTMLElement} target The target manageable
     * @param {String} uiState The ui-state to remove for the manageable
     */
    function removeUiState(target, uiState) {
      var element = (angular.element(target).scope().device) ?
        angular.element(target).scope().device : angular.element(target).scope().group;
      var index = element[&#x27;ui-state&#x27;].indexOf(uiState);

      element[&#x27;ui-state&#x27;].splice(index, 1);
      $scope.$apply();
    }

    /**
     * Handles drag move event on manageables.
     *
     * @method dragMoveListener
     * @private
     * @param {Event} event The drag event
     */
    function dragMoveListener(event) {
      var element = angular.element(event.target),
        x = (parseFloat(element.attr(&#x27;data-x&#x27;)) || 0) + event.dx,
        y = (parseFloat(element.attr(&#x27;data-y&#x27;)) || 0) + event.dy;

      // Translate the element
      element.css({
        &#x27;-webkit-transform&#x27;: &#x27;translate(&#x27; + x + &#x27;px, &#x27; + y + &#x27;px)&#x27;,
        transform: &#x27;translate(&#x27; + x + &#x27;px, &#x27; + y + &#x27;px)&#x27;
      });

      // Update the position attributes
      element.attr(&#x27;data-x&#x27;, x);
      element.attr(&#x27;data-y&#x27;, y);
    }

    /**
     * Resets the manageable element to its initial position.
     *
     * @method resetPosition
     * @private
     * @param {HTMLElement} target the element to reset
     */
    function resetPosition(target) {
      var element = angular.element(target);

      // Set transition duration for reset
      element.css({
        &#x27;-webkit-transition-duration&#x27;: &#x27;.35s&#x27;,
        &#x27;transition-duration&#x27;: &#x27;.35s&#x27;,
        &#x27;-webkit-transform&#x27;: &#x27;translate(0, 0)&#x27;,
        transform: &#x27;translate(0, 0)&#x27;
      });
      element.parent().css({
        &#x27;z-index&#x27;: 2
      });

      // Update the position attributes
      element.attr(&#x27;data-x&#x27;, 0);
      element.attr(&#x27;data-y&#x27;, 0);
    }

    /**
     * Sets position of the target element to the dropzone element.
     *
     * @method mergePosition
     * @private
     * @param {HTMLElement} target the dropzone element
     * @param {Object} relatedTarget target the dragged element to move
     */
    function mergePosition(target, relatedTarget) {
      var x = parseInt(target.getBoundingClientRect().left) -
          (relatedTarget.parentNode.getBoundingClientRect().left + 15),
        y = parseInt(target.getBoundingClientRect().top - relatedTarget.parentNode.getBoundingClientRect().top),
        element = angular.element(relatedTarget);

      if (target.classList.contains(&#x27;group&#x27;)) {
        x = parseInt(x + 41);
        y = parseInt(y - 66);
      }

      element.css({
        &#x27;-webkit-transition-duration&#x27;: &#x27;.5s&#x27;,
        &#x27;transition-duration&#x27;: &#x27;.5s&#x27;,
        &#x27;-webkit-transform&#x27;: &#x27;translate(&#x27; + x + &#x27;px, &#x27; + y + &#x27;px)&#x27;,
        transform: &#x27;translate(&#x27; + x + &#x27;px, &#x27; + y + &#x27;px)&#x27;
      });

      removeUiState(target, &#x27;can-drop&#x27;);
    }

    /**
     * Sets items as draggable.
     *
     * @method draggable
     * @private
     */
    function draggable() {
      interact(&#x27;.draggable&#x27;).draggable({
        inertia: false,

        // Define the restricted area
        restrict: {
          restriction: &#x27;#page-content-wrapper&#x27;,
          endOnly: true
        },
        autoScroll: true,

        onstart: function(event) {
          var element = angular.element(event.target);
          addUiState(event.target, &#x27;drag&#x27;);
          self.currentlyDragging = true;

          // Set transition duration for reset
          element.css({
            &#x27;-webkit-transition-duration&#x27;: &#x27;0s&#x27;,
            &#x27;transition-duration&#x27;: &#x27;0s&#x27;
          });
          element.parent().css({
            &#x27;z-index&#x27;: 1
          });
        },

        onmove: dragMoveListener,

        onend: function(event) {
          var target = event.target;

          if (!angular.element(target).hasClass(&#x27;drop-target&#x27;)) {
            removeUiState(target, &#x27;drag&#x27;);
            resetPosition(target);
          }
        }
      });
    }

    /**
     * Adds a device to a group.
     *
     * @method addDeviceToGroup
     * @private
     * @param {String} deviceId The id of the device to add to the group
     * @param {String} groupId The id of group
     * @return {Promise} Promise resolving when device is added
     */
    function addDeviceToGroup(deviceId, groupId) {
      var p = $q.defer();
      var device = DeviceFactory.getDevice(deviceId);
      var group = GroupFactory.getGroup(groupId);
      var isCollision = DeviceFactory.isGroupSchedulesCollision(device.id, group);

      if (isCollision) {
        $scope.$emit(
          &#x27;setAlert&#x27;,
          &#x27;danger&#x27;,
          $filter(&#x27;translate&#x27;)(&#x27;MANAGE.GROUP.ADD_DEVICE_SCHEDULES_COLLISION_ERROR&#x27;, null, {
            deviceName: $filter(&#x27;translate&#x27;)(device.name),
            groupName: $filter(&#x27;translate&#x27;)(group.name)
          })
        );
        p.reject();
      } else {
        ManageFactory.addDeviceToGroup(deviceId, groupId).then(function() {
          GroupFactory.addDeviceToGroup(device, groupId);
          p.resolve();
        }, function(error) {
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;danger&#x27;, $filter(&#x27;translate&#x27;)(&#x27;MANAGE.GROUP.ADD_DEVICE_ERROR&#x27;, null, {
            code: error.code,
            name: $filter(&#x27;translate&#x27;)(group.name)
          }), 4000);
          p.reject(error);
        });
      }

      return p.promise;
    }

    /**
     * Sets drag drop zones.
     *
     * @method dragDropDevice
     * @private
     */
    function dragDropDevice() {
      interact(&#x27;.dropzone&#x27;).dropzone({

        // only accept elements matching this CSS selector
        accept: &#x27;.draggable&#x27;,

        // Require a 25% element overlap for a drop to be possible
        overlap: 0.25,

        ondragenter: function(event) {
          addUiState(event.target, &#x27;can-drop&#x27;);
          addUiState(event.relatedTarget, &#x27;drop-target&#x27;);
        },
        ondragleave: function(event) {
          removeUiState(event.relatedTarget, &#x27;drop-target&#x27;);
          removeUiState(event.target, &#x27;can-drop&#x27;);
        },
        ondrop: function(event) {
          var relatedTarget = angular.element(event.relatedTarget),
            target = angular.element(event.target);

          mergePosition(event.target, event.relatedTarget);
          removeUiState(event.target, &#x27;can-drop&#x27;);
          removeUiState(event.relatedTarget, &#x27;drop-target&#x27;);

          $timeout(function() {

            if (!target.hasClass(&#x27;group&#x27;)) {

              // No group
              // Create it
              ManageFactory.createGroup().then(function(group) {
                GroupFactory.addGroup(group);

                // Add both devices (the dragged one and the target one)
                // to the new group
                addDeviceToGroup(relatedTarget.attr(&#x27;data-id&#x27;), group.id);
                addDeviceToGroup(target.attr(&#x27;data-id&#x27;), group.id);

              }, function(error) {
                $scope.$emit(&#x27;setAlert&#x27;, &#x27;danger&#x27;, $filter(&#x27;translate&#x27;)(&#x27;MANAGE.GROUP.CREATE_ERROR&#x27;, null, {
                  code: error.code
                }), 4000);
                resetPosition(relatedTarget);
                resetPosition(target);
              });

            } else {

              // Add dragged device to the target group
              addDeviceToGroup(relatedTarget.attr(&#x27;data-id&#x27;), target.attr(&#x27;data-id&#x27;)).catch(function() {
                resetPosition(relatedTarget);
              });

            }

            $scope.$apply();
          }, 350);
        }
      });
    }

    /**
     * Toggles the detail panel corresponding to the given manageable.
     *
     * @method toggleDetails
     * @param {String} id The manageable id
     * @param {Boolean} isGroup true if the manageable is a group, false if it is a device
     * @private
     */
    function toggleDetails(id, isGroup) {
      if (!$scope.manage.openedItem) {

        // No manageable loaded in the detail panel yet

        // Set the selected manageable
        $rootScope.$broadcast(&#x27;manageable.load&#x27;, id, isGroup);

        $scope.manage.openedItem = id;
        $scope.manage.showDetail = true;
        $scope.organizeLayout($scope.manage.showDetail);

      } else if ($scope.manage.openedItem == id) {

        // Manageable to load in the panel is the one already loaded
        // Close the panel
        $rootScope.$broadcast(&#x27;manageable.closeDetails&#x27;);

      } else {

        // Manageable to load in the details panel is a different manageable
        // Display new manageable details
        // And activate first tab

        $scope.manage.openedItem = id;
        $scope.manage.showDetail = false;
        $scope.setActivePage(0);

        $rootScope.$broadcast(&#x27;manageable.load&#x27;, id, isGroup);
        $scope.manage.showDetail = true;

      }
    }

    /**
     * Opens the detail view corresponding to the given group.
     *
     * @method openGroup
     * @param {String} id The group id
     * @private
     */
    function openGroup(id) {
      $rootScope.$broadcast(&#x27;manageable.closeDetails&#x27;);
      $scope.manage.showDetail = false;
      $location.path(&#x27;manage/group-detail/&#x27; + id);
      $scope.manage.absUrl = $location.absUrl();
    }

    /**
     * Handles clicks and double clicks on manageable items to toggle details or open groups.
     *
     * @method handleManageableClick
     * @param {Event} The click event
     */
    self.handleManageableClick = function(event) {
      var manageableId = event.currentTarget.getAttribute(&#x27;data-id&#x27;);
      var isGroup = angular.element(event.currentTarget).hasClass(&#x27;group&#x27;);

      if (self.doubleClickPromise) {
        $timeout.cancel(self.doubleClickPromise);
        self.doubleClickPromise = null;

        // Double click

        // Only for groups
        if (isGroup &amp;&amp; manageableId)
          openGroup(manageableId);

        return;
      }

      self.doubleClickPromise = $timeout(function() {

        // Single click
        self.doubleClickPromise = null;
        toggleDetails(manageableId, isGroup);

      }, 200);
    };

    /**
     * Adds pending/refused device to the accepted list of devices.
     *
     * @method addToAcceptedDevices
     * @param {Object} device The device to accept
     * @param {String} device.id The device&#x27;s id
     */
    self.addToAcceptedDevices = function(device) {
      ManageFactory.updateDeviceState(device.id, MANAGE_DEVICE_STATES.ACCEPTED).then(function() {
        ManageFactory.askForDevicesSettings([device.id]);
      }, function(error) {
        $scope.$emit(&#x27;setAlert&#x27;, &#x27;danger&#x27;, $filter(&#x27;translate&#x27;)(&#x27;MANAGE.DEVICE.ADD_ACCEPTED_ERROR&#x27;, null, {
          code: error.code
        }), 4000);
      });
    };

    /**
     * Adds the new device to the refused list of devices.
     *
     * @method addToRefusedDevices
     * @param {Object} device The device object
     * @param {String} device.id The device&#x27;s id
     */
    self.addToRefusedDevices = function(device) {
      ManageFactory.updateDeviceState(device.id, MANAGE_DEVICE_STATES.REFUSED).catch(function(error) {
        $scope.$emit(&#x27;setAlert&#x27;, &#x27;danger&#x27;, $filter(&#x27;translate&#x27;)(&#x27;MANAGE.DEVICE.ADD_REFUSED_ERROR&#x27;, null, {
          code: error.code
        }), 4000);
      });
    };

    /**
     * Destroys controller.
     *
     * AngularJS hook.
     */
    self.$onDestroy = function() {
      interact(&#x27;.draggable&#x27;).unset();
      interact(&#x27;.dropzone&#x27;).unset();
    };

    // Manage drag and drop events
    if ($element.hasClass(&#x27;devices&#x27;)) {
      draggable();
      dragDropDevice();
    }

  }

  app.controller(&#x27;ManageManageableController&#x27;, ManageableController);
  ManageableController.$inject = [
    &#x27;$q&#x27;,
    &#x27;$scope&#x27;,
    &#x27;$rootScope&#x27;,
    &#x27;$filter&#x27;,
    &#x27;$timeout&#x27;,
    &#x27;$location&#x27;,
    &#x27;$element&#x27;,
    &#x27;ManageFactory&#x27;,
    &#x27;ManageGroupFactory&#x27;,
    &#x27;ManageDeviceFactory&#x27;,
    &#x27;entityService&#x27;,
    &#x27;MANAGE_NAME&#x27;,
    &#x27;MANAGE_DEVICE_STATES&#x27;
  ];

})(angular.module(&#x27;ov.manage&#x27;));

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
