<!DOCTYPE html>
<html lang="en" class="yui-overrride">
<head>
    <meta charset="utf-8">
    <title>app/client/admin/js/ovManage/MainController.js - OpenVeo Manage AngularJS back end</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1 class="blue-main-title">OpenVeo Manage AngularJS back end</h1>
        </div>
        <div class="yui3-u-1-4 version project-version">
            API Docs for: 4.0.0
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ManageDeviceFactory.html">ManageDeviceFactory</a></li>
                                <li><a href="../classes/ManageFactory.html">ManageFactory</a></li>
                                <li><a href="../classes/ManageGroupFactory.html">ManageGroupFactory</a></li>
                                <li><a href="../classes/ManageMainController.html">ManageMainController</a></li>
                                <li><a href="../classes/ManageManageableController.html">ManageManageableController</a></li>
                                <li><a href="../classes/ManageManageableDetailController.html">ManageManageableDetailController</a></li>
                                <li><a href="../classes/ManageManageableFactory.html">ManageManageableFactory</a></li>
                                <li><a href="../classes/ovManageSortTable.html">ovManageSortTable</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ov.manage.html">ov.manage</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app/client/admin/js/ovManage/MainController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

(function(app) {

  /**
   * @module ov.manage
   */

  /**
   * Defines the manage controller.
   *
   * @class ManageMainController
   * @static
   */
  function MainController(
    $q,
    $scope,
    $window,
    $location,
    $filter,
    $route,
    $rootScope,
    $timeout,
    devices,
    groups,
    ManageFactory,
    GroupFactory,
    DeviceFactory,
    SocketFactory,
    entityService,
    MANAGE_NAME,
    DEVICE_STATES,
    DEVICE_STATUS,
    MANAGEABLE_TYPES) {
    var devicesIds = [],
      activePage = 0,
      group = GroupFactory.getGroup($route.current.params.id);

    // Add devices to groups
    GroupFactory.addDevices(devices[DEVICE_STATES.ACCEPTED]);

    // Initialize data
    if (group) {
      $scope.group = group;
      $scope.acceptedDevices = group.devices;
    } else {
      $scope.acceptedDevices = devices[DEVICE_STATES.ACCEPTED];
    }

    $scope.DEVICE_STATES = DEVICE_STATES;
    $scope.DEVICE_STATUS = DEVICE_STATUS;
    $scope.MANAGEABLE_TYPES = MANAGEABLE_TYPES;
    $scope.groups = groups;
    $scope.refusedDevices = devices[DEVICE_STATES.REFUSED];
    $scope.pendingDevices = devices[DEVICE_STATES.PENDING];
    $scope.manage = {
      resize: &#x27;normal&#x27;, // Permits to resize the devices tiles (normal/medium/small)
      openedItem: null, // Contain the id of the selected device
      showDetail: false, // Used to add a class to the selected device
      absUrl: $location.absUrl() // The URL of the current page
    };

    $scope.incomingDevices = DeviceFactory.getDevicesByState(DEVICE_STATES.INCOMING); // The new incoming devices

    // Initialize socket.io connection
    $scope.socket = SocketFactory.initSocket();

    /**
     * Handles messages from the server informing about a new connected device.
     *
     * @method handleDeviceConnected
     * @private
     * @param {Object} device The new connected device information
     */
    function handleDeviceConnected(device) {
      if (device) {
        DeviceFactory.addDevice(device, DEVICE_STATES.INCOMING);
        $scope.$apply();
      }
    }

    /**
     * Handles messages from the server requesting a manageable to be removed.
     *
     * @method handleRemoved
     * @private
     * @param {Object} data Data from server
     * @param {String} data.id The manageable id
     * @param {String} data.type The manageable type
     */
    function handleRemoved(data) {
      if (data.type === MANAGEABLE_TYPES.DEVICE) {
        var device = DeviceFactory.getDevice(data.id);

        // Remove device from its group
        if (device &amp;&amp; device.group) {
          var group = GroupFactory.getGroup(device.group);
          GroupFactory.removeDeviceFromGroup(device, device.group);

          if (!group.devices.length)
            GroupFactory.removeGroup(device.group);
        }

        DeviceFactory.remove(data.id);
        $scope.$broadcast(&#x27;manageable.closeDetails&#x27;);
      } else if (data.type === MANAGEABLE_TYPES.GROUP) {
        GroupFactory.removeGroup(data.id);

        // Navigate back if we are in a group page
        if ($route.current.params.id)
          $scope.$broadcast(&#x27;back&#x27;);
        else
          $scope.$broadcast(&#x27;manageable.closeDetails&#x27;);
      }
    }

    /**
     * Handles messages from the server requesting a modification on a manageable.
     *
     * @method handleUpdated
     * @private
     * @param {Object} data Data from server
     * @param {String} data.id The manageable id
     * @param {String} data.key The property to update
     * @param {Mixed} data.value The property value
     * @param {String} data.type The manageable type
     */
    function handleUpdated(data) {
      if (data.type === MANAGEABLE_TYPES.DEVICE) {
        var device = DeviceFactory.getDevice(data.id);
        DeviceFactory.setProperty(data.id, data.key, data.value);
        GroupFactory.updateStatus(device.group);
      } else
        GroupFactory.setProperty(data.id, data.key, data.value);

      $scope.$apply();
    }

    /**
     * Handles messages from the server requesting an historic to be added to the history of a manageable.
     *
     * @method handleNewHistoric
     * @private
     * @param {Object} data Data from server
     * @param {String} data.id The manageable id
     * @param {Object} data.historic The historic to add to history
     * @param {String} data.type The manageable type
     */
    function handleNewHistoric(data) {
      var factory = (data.type === MANAGEABLE_TYPES.DEVICE) ? DeviceFactory : GroupFactory;
      factory.addHistoric(data.id, data.historic);
      $scope.$apply();
    }

    /**
     * Handles messages from the server requesting an historic to be removed from the history of a manageable.
     *
     * @method handleRemovedHistoric
     * @private
     * @param {Object} data Data from server
     * @param {String} data.id The manageable id
     * @param {Object} data.historicId The historic id
     * @param {String} data.type The manageable type
     */
    function handleRemovedHistoric(data) {
      var factory = (data.type === MANAGEABLE_TYPES.DEVICE) ? DeviceFactory : GroupFactory;
      factory.removeHistoric(data.id, data.historicId);
      $scope.$apply();
    }

    /**
     * Handles messages from the server requesting a manageable&#x27;s history to be removed.
     *
     * @method handleRemovedHistory
     * @private
     * @param {Object} data Data from server
     * @param {String} data.id The manageable id
     * @param {String} data.type The manageable type
     */
    function handleRemovedHistory(data) {
      var factory = (data.type === MANAGEABLE_TYPES.DEVICE) ? DeviceFactory : GroupFactory;
      factory.removeHistory(data.id);
      $scope.$apply();
    }

    /**
     * Handles messages from the server requesting a schedule to be added to a manageable.
     *
     * @method handleNewSchedule
     * @private
     * @param {Object} data Data from server
     * @param {String} data.id The manageable id
     * @param {Object} data.schedule The schedule
     * @param {String} data.type The manageable type
     */
    function handleNewSchedule(data) {
      var factory = (data.type === MANAGEABLE_TYPES.DEVICE) ? DeviceFactory : GroupFactory;
      factory.addSchedule(data.id, data.schedule);
      $scope.$apply();
    }

    /**
     * Handles messages from the server requesting a schedule to be removed from a manageable.
     *
     * @method handleRemovedSchedule
     * @private
     * @param {Object} data Data from server
     * @param {String} data.id The manageable id
     * @param {Object} data.scheduleId The schedule id
     * @param {String} data.type The manageable type
     */
    function handleRemovedSchedule(data) {
      var factory = (data.type === MANAGEABLE_TYPES.DEVICE) ? DeviceFactory : GroupFactory;
      factory.removeSchedule(data.id, data.scheduleId);
      $scope.$apply();
    }

    /**
     * Handles messages from the server requesting state modification on a device.
     *
     * @method handleDeviceUpdatedState
     * @private
     * @param {Object} data Data from server
     * @param {String} data.id The device id
     * @param {String} data.state The device new state
     */
    function handleDeviceUpdatedState(data) {
      DeviceFactory.updateDeviceState(data.id, data.state);
      $scope.$apply();
    }

    /**
     * Handles messages from the server requesting a group to be created.
     *
     * @method handleGroupCreated
     * @private
     * @param {Object} data Data from server
     * @param {Object} data.group The group to add
     */
    function handleGroupCreated(data) {
      if (data.group)
        GroupFactory.addGroup(data.group);
    }

    /**
     * Handles messages from the server requesting a device to be added to a group.
     *
     * @method handleGroupNewDevice
     * @private
     * @param {Object} data Data from server
     * @param {String} data.deviceId The device id
     * @param {String} data.groupId The group id
     */
    function handleGroupNewDevice(data) {
      if (data.deviceId &amp;&amp; data.groupId) {
        GroupFactory.addDeviceToGroup(DeviceFactory.getDevice(data.deviceId), data.groupId);

        // Send an event to close the device detail window
        $timeout(function() {
          $rootScope.$broadcast(&#x27;manageable.closeDetails&#x27;);
        }, 250);

      }
    }

    /**
     * Handles messages from the server requesting a device to be removed from a group.
     *
     * @method handleGroupRemovedDevice
     * @private
     * @param {Object} data Data from server
     * @param {String} data.id The device id
     */
    function handleGroupRemovedDevice(data) {
      var device = DeviceFactory.getDevice(data.id);

      if (device) {
        var group = GroupFactory.getGroup(device.group);

        if (group) {

          GroupFactory.removeDeviceFromGroup(device, device.group);

          // Send an event to close the device detail window
          $rootScope.$broadcast(&#x27;manageable.closeDetails&#x27;);

        }

      }

    }

    $scope.socket.on(&#x27;device.connected&#x27;, handleDeviceConnected);
    $scope.socket.on(&#x27;removed&#x27;, handleRemoved);
    $scope.socket.on(&#x27;updated&#x27;, handleUpdated);
    $scope.socket.on(&#x27;newHistoric&#x27;, handleNewHistoric);
    $scope.socket.on(&#x27;removedHistoric&#x27;, handleRemovedHistoric);
    $scope.socket.on(&#x27;removedHistory&#x27;, handleRemovedHistory);
    $scope.socket.on(&#x27;newSchedule&#x27;, handleNewSchedule);
    $scope.socket.on(&#x27;removedSchedule&#x27;, handleRemovedSchedule);
    $scope.socket.on(&#x27;device.updatedState&#x27;, handleDeviceUpdatedState);
    $scope.socket.on(&#x27;group.created&#x27;, handleGroupCreated);
    $scope.socket.on(&#x27;group.newDevice&#x27;, handleGroupNewDevice);
    $scope.socket.on(&#x27;group.removedDevice&#x27;, handleGroupRemovedDevice);

    /**
     * Defines the active page index.
     *
     * @method setActivePage
     * @param index The tab index
     */
    $scope.setActivePage = function(index) {
      activePage = index;
    };

    /**
     * Determines if the passed index is the active page index.
     *
     * @method isActivePage
     * @param index The tab index
     * @return {Boolean} true if the given index is the selected tab index
     */
    $scope.isActivePage = function(index) {
      return activePage === index;
    };

    /**
     * Permits to organize the view when the details is opened/closed.
     *
     * @method organizeLayout
     * @param {Boolean} opening ????
     */
    $scope.organizeLayout = function(opening) {
      var screenWidth = $window.innerWidth,
        containerWidth = parseInt(document.getElementsByClassName(&#x27;manage-container&#x27;)[0].offsetWidth + 30),
        leftSpace = parseInt(screenWidth - containerWidth) / 2;

      if (opening &amp;&amp; leftSpace &lt;= 300) {
        if (containerWidth &lt;= 750) {
          $scope.manage.resize = &#x27;small&#x27;;
        } else {
          $scope.manage.resize = &#x27;medium&#x27;;
        }
      } else {
        $scope.manage.resize = &#x27;normal&#x27;;
      }
    };

    /**
     * Navigates to the previous page in browser&#x27;s history.
     *
     * @method back
     */
    $scope.back = function() {
      $scope.manage.showDetail = false;
      $scope.manage.openedItem = null;
      $scope.organizeLayout(false);
      $location.path(&#x27;manage&#x27;);
      $scope.manage.absUrl = $location.absUrl();
    };

    /**
     * Removes a group.
     *
     * @method removeGroup
     * @param {String} id The id of the group to remove
     */
    $scope.removeGroup = function(id) {
      ManageFactory.remove(id, MANAGEABLE_TYPES.GROUP).catch(function(error) {
        $scope.$emit(&#x27;setAlert&#x27;, &#x27;danger&#x27;, $filter(&#x27;translate&#x27;)(&#x27;MANAGE.GROUP.REMOVE_ERROR&#x27;, null, {
          code: error.code
        }), 4000);
      });
    };

    /**
     * Removes a device from its group.
     *
     * @method removeFromGroup
     * @param {String} id The id of the device to remove
     */
    $scope.removeFromGroup = function(id) {
      var device = DeviceFactory.getDevice(id);
      var group = GroupFactory.getGroup(device.group);

      // If there is only 2 devices the group is removed
      if (group.devices.length == 2) {

        // Remove group
        $scope.removeGroup(group.id);
        $rootScope.$broadcast(&#x27;manageable.closeDetails&#x27;);

      } else {
        ManageFactory.removeDeviceFromGroup(device.id).then(function() {
          GroupFactory.removeDeviceFromGroup(device.id, device.group);
        }, function(error) {
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;danger&#x27;, $filter(&#x27;translate&#x27;)(&#x27;MANAGE.GROUP.REMOVE_DEVICE_ERROR&#x27;, null, {
            code: error.code,
            name: $filter(&#x27;translate&#x27;)(device.name)
          }), 4000);
        });
      }
    };

    // Asks for devices settings only once
    if (!devicesIds.length) {
      $scope.acceptedDevices.forEach(function(device) {
        devicesIds.push(device.id);
      });

      if (devicesIds.length)
        ManageFactory.askForDevicesSettings(devicesIds);
    }

    $scope.$on(&#x27;$destroy&#x27;, function() {
      $scope.socket.off(&#x27;device.connected&#x27;, handleDeviceConnected);
      $scope.socket.off(&#x27;removed&#x27;, handleRemoved);
      $scope.socket.off(&#x27;updated&#x27;, handleUpdated);
      $scope.socket.off(&#x27;newHistoric&#x27;, handleNewHistoric);
      $scope.socket.off(&#x27;removedHistoric&#x27;, handleRemovedHistoric);
      $scope.socket.off(&#x27;removedHistory&#x27;, handleRemovedHistory);
      $scope.socket.off(&#x27;newSchedule&#x27;, handleNewSchedule);
      $scope.socket.off(&#x27;removedSchedule&#x27;, handleRemovedSchedule);
      $scope.socket.off(&#x27;device.updatedState&#x27;, handleDeviceUpdatedState);
      $scope.socket.off(&#x27;group.created&#x27;, handleGroupCreated);
      $scope.socket.off(&#x27;group.newDevice&#x27;, handleGroupNewDevice);
      $scope.socket.off(&#x27;group.removedDevice&#x27;, handleGroupRemovedDevice);
    });
  }

  app.controller(&#x27;ManageMainController&#x27;, MainController);
  MainController.$inject = [
    &#x27;$q&#x27;,
    &#x27;$scope&#x27;,
    &#x27;$window&#x27;,
    &#x27;$location&#x27;,
    &#x27;$filter&#x27;,
    &#x27;$route&#x27;,
    &#x27;$rootScope&#x27;,
    &#x27;$timeout&#x27;,
    &#x27;manageDevices&#x27;,
    &#x27;manageGroups&#x27;,
    &#x27;ManageFactory&#x27;,
    &#x27;ManageGroupFactory&#x27;,
    &#x27;ManageDeviceFactory&#x27;,
    &#x27;SocketFactory&#x27;,
    &#x27;entityService&#x27;,
    &#x27;MANAGE_NAME&#x27;,
    &#x27;MANAGE_DEVICE_STATES&#x27;,
    &#x27;MANAGE_DEVICE_STATUS&#x27;,
    &#x27;MANAGE_MANAGEABLE_TYPES&#x27;
  ];

})(angular.module(&#x27;ov.manage&#x27;));

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
