<!DOCTYPE html>
<html lang="en" class="yui-overrride">
<head>
    <meta charset="utf-8">
    <title>app\client\admin\js\ovManage\GroupFactory.js - OpenVeo Manage AngularJS back end</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1 class="blue-main-title">OpenVeo Manage AngularJS back end</h1>
        </div>
        <div class="yui3-u-1-4 version project-version">
            API Docs for: 1.1.0
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ManageDeviceFactory.html">ManageDeviceFactory</a></li>
                                <li><a href="../classes/ManageFactory.html">ManageFactory</a></li>
                                <li><a href="../classes/ManageGroupFactory.html">ManageGroupFactory</a></li>
                                <li><a href="../classes/ManageMainController.html">ManageMainController</a></li>
                                <li><a href="../classes/ManageManageableController.html">ManageManageableController</a></li>
                                <li><a href="../classes/ManageManageableDetailController.html">ManageManageableDetailController</a></li>
                                <li><a href="../classes/ManageManageableFactory.html">ManageManageableFactory</a></li>
                                <li><a href="../classes/ovManageSortTable.html">ovManageSortTable</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ov.manage.html">ov.manage</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app\client\admin\js\ovManage\GroupFactory.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

(function(app) {

  /**
   * @module ov.manage
   */

  /**
   * Defines a factory to manage groups.
   *
   * @class ManageGroupFactory
   * @static
   */
  function GroupFactory($q,
                         $rootScope,
                         $timeout,
                         $filter,
                         DEVICE_STATUS,
                         MANAGEABLE_TYPES,
                         DeviceFactory,
                         ManageFactory,
                         ManageableFactory
                        ) {
    var TOTAL_PRESETS = 5;
    var groups = null;
    var presets = [];

    // Create presets for groups
    // Use preset id as preset name
    for (var i = 1; i &lt; TOTAL_PRESETS + 1; i++)
      presets.push({id: String(i), name: String(i)});

    /**
     * Gets a group by its id.
     *
     * It implies that the list of groups has been retrieved
     * from server using GroupFactory.getGroups().
     *
     * @method getGroup
     * @param {String} id The group id
     * @return {Object|Null} The group or null if not found
     */
    function getGroup(id) {
      for (var i = 0; i &lt; groups.length; i++)
        if (groups[i].id === id) return groups[i];

      return null;
    }

    /**
     * Updates status of a group regarding the status of its devices.
     *
     * @method updateStatus
     * @param {String} groupId The group id
     */
    function updateStatus(groupId) {
      var group = getGroup(groupId);

      if (group) {
        var groupReady = false;

        // If one device in the group is not able to start a session
        // mark the whole group as not able to start a session
        for (var i = 0; i &lt; group.devices.length; i++) {

          // Update device status
          var device = group.devices[i];

          switch (device.status) {
            case DEVICE_STATUS.ERROR:
              group.statusMessage = &#x27;MANAGE.STATUS.ERROR&#x27;;
              group.status = DEVICE_STATUS.ERROR;
              return;
            case DEVICE_STATUS.STARTED:
            case DEVICE_STATUS.STOPPING:
              group.statusMessage = &#x27;MANAGE.STATUS.RECORDING&#x27;;
              group.status = DEVICE_STATUS.STARTED;
              return;
            case DEVICE_STATUS.STARTING:
              group.statusMessage = &#x27;MANAGE.STATUS.STARTING&#x27;;
              group.status = DEVICE_STATUS.STARTING;
              return;
            default:
              if (device.status == DEVICE_STATUS.STOPPED)
                groupReady = true;
          }
        }

        if (groupReady) {

          // All devices in the group are not in error, started or starting state
          // and at least one device is stopped
          group.statusMessage = &#x27;MANAGE.STATUS.READY&#x27;;
          group.status = DEVICE_STATUS.STOPPED;

        } else {

          // No devices connected
          group.statusMessage = &#x27;MANAGE.STATUS.DISCONNECTED&#x27;;
          group.status = DEVICE_STATUS.DISCONNECTED;

        }
      }
    }

    /**
     * Adds a group&#x27;s historic.
     *
     * @method addHistoric
     * @param {String} id The group id
     * @param {Object} historic The historic
     */
    function addHistoric(id, historic) {
      var group = getGroup(id);
      ManageableFactory.addHistoric(group, historic);
    }

    /**
     * Adds a group&#x27;s schedule.
     *
     * @method addSchedule
     * @param {String} id The group id
     * @param {Object} schedule The schedule
     */
    function addSchedule(id, schedule) {
      var group = getGroup(id);
      ManageableFactory.addSchedule(group, schedule);
    }

    /**
     * Removes a group&#x27;s historic.
     *
     * @method removeHistoric
     * @param {String} id The group id
     * @param {String} historicId The historic id
     */
    function removeHistoric(id, historicId) {
      var group = getGroup(id);
      ManageableFactory.removeHistoric(group, historicId);
    }

    /**
     * Removes a device&#x27;s history.
     *
     * @method removeHistory
     * @param {String} id The device id
     */
    function removeHistory(id) {
      var group = getGroup(id);
      ManageableFactory.removeHistory(group);
    }

    /**
     * Removes a group&#x27;s schedule.
     *
     * @method removeSchedule
     * @param {String} groupId The group id
     * @param {String} scheduleId The schedule id
     */
    function removeSchedule(groupId, scheduleId) {
      var group = getGroup(groupId);
      ManageableFactory.removeSchedule(group, scheduleId);
    }

    /**
     * Gets a device from a group.
     *
     * @method getDeviceFromGroup
     * @param {String} deviceId The id of the device
     * @param {String} groupId The id of the group
     * @return {Object|Null} The device or null if not found
     */
    function getDeviceFromGroup(deviceId, groupId) {
      var group = getGroup(groupId);

      if (group) {
        for (var i = 0; i &lt; group.devices.length; i++)
          if (group.devices[i].id === deviceId) return group.devices[i];
      }

      return null;
    }

    /**
     * Adds a device to a group.
     *
     * @method addDeviceToGroup
     * @param {Object} device The device to add to the group
     * @param {String} groupId The id of the group
     */
    function addDeviceToGroup(device, groupId) {
      if (device &amp;&amp; groupId) {
        var group = getGroup(groupId);
        var existingDevice = getDeviceFromGroup(device.id, groupId);

        if (!existingDevice) {
          device.group = groupId;

          if (!group.devices)
            group.devices = [];

          group.devices.push(device);
          updateStatus(group.id);
        }

      }
    }

    /**
     * Adds a new group.
     *
     * @method addGroup
     * @param {Object} group The new group description object
     * @param {String} group.id Group&#x27;s id
     * @param {Array} [group.history] Group&#x27;s history
     */
    function addGroup(group) {
      if (!getGroup(group.id)) {
        var history = group.history;
        group.type = MANAGEABLE_TYPES.GROUP;
        group.devices = [];
        group.history = [];
        group.inputs = {};
        group.presets = presets;
        groups.push(group);

        history.forEach(function(historic) {
          addHistoric(group.id, historic);
        });

        updateStatus(group.id);
      }
    }

    /**
     * Gets all groups from server.
     *
     * @method getGroups
     * @return {Promise} A promise resolving with the list of groups
     */
    function getGroups() {
      var p = $q.defer();

      if (!groups) {
        ManageFactory.getGroups().then(function(newGroups) {
          groups = [];

          newGroups.forEach(function(group) {
            addGroup(group);
          });

          p.resolve(groups);
        }, function(error) {
          p.reject(error);
        });
      } else
        p.resolve(groups);

      return p.promise;
    }

    /**
     * Adds devices to their respecting group.
     *
     * It uses the group property of each device.
     *
     * @method addDevices
     * @param {Array} devices The list of devices
     */
    function addDevices(devices) {
      if (groups &amp;&amp; devices) {

        // Iterate through devices
        for (var i in devices) {
          var deviceGroupId = devices[i].group;

          // Iterate through groups
          for (var j in groups) {

            if (groups[j].id === deviceGroupId) {

              // Found device&#x27;s group
              // Add device to the group
              addDeviceToGroup(devices[i], groups[j].id);
              break;

            }
          }
        }
      }
    }

    /**
     * Sets a property on all groups.
     *
     * @method setGroupsProperty
     * @param {String} property The name of the property to set
     * @param {Mixed} value The value for the property
     */
    function setGroupsProperty(property, value) {
      groups.forEach(function(group) {
        group[property] = value;
      });
    }

    /**
     * Removes a group.
     *
     * @method removeGroup
     * @param {String} id The group id
     */
    function removeGroup(id) {
      var groupIndex = -1;
      var group = null;
      for (var i = 0; i &lt; groups.length; i++) {
        if (groups[i].id === id) {
          groupIndex = i;
          group = groups[i];
          break;
        }
      }

      // Remove devices from group
      if (group) {
        group.devices.forEach(function(device) {
          delete device.group;
        });
      }

      // Remove group
      if (groupIndex !== -1)
        groups.splice(groupIndex, 1);
    }

    /**
     * Updates a group property.
     *
     * @method setProperty
     * @param {String} id The group id
     * @param {String} property The property to modify
     * @param {Mixed} value The property value
     */
    function setProperty(id, property, value) {
      var group = getGroup(id);

      if (group)
        group[property] = value;
    }

    /**
     * Removes a device from a group.
     *
     * @method removeDeviceFromGroup
     * @param {Object} device The device to remove
     * @param {String} device.id The device&#x27;s id
     * @param {String} device.group The device&#x27;s group
     * @param {String} groupId The group id
     */
    function removeDeviceFromGroup(device, groupId) {
      var group = getGroup(groupId),
        deviceIndex = -1;

      if (device &amp;&amp; group) {
        for (var i = 0; i &lt; group.devices.length; i++) {
          if (group.devices[i].id === device.id) {
            deviceIndex = i;
            break;
          }
        }

        if (deviceIndex !== -1)
          group.devices.splice(deviceIndex, 1);

        delete device.group;
      }
    }

    /**
     * Validates a preset confronting group&#x27;s devices&#x27; available inputs.
     *
     * If one of the devices has invalid inputs regarding the preset, preset
     * is considered invalid.
     *
     * @method validatePreset
     * @param {String} groupId The group id
     * @param {String} presetId The preset id
     */
    function validatePreset(groupId, presetId) {
      var group = getGroup(groupId);

      if (group) {
        var devicesInError = [];

        group.devices.forEach(function(device) {
          DeviceFactory.validatePreset(device.id, presetId);

          if (device.inputs.error)
            devicesInError.push($filter(&#x27;translate&#x27;)(device.name));
        });

        if (devicesInError.length) {
          group.inputs.error = $filter(&#x27;translate&#x27;)(&#x27;MANAGE.GROUP.PRESET_INPUTS_ERROR&#x27;, null, {
            devices: devicesInError.join(&#x27;, &#x27;)
          });
        } else
          group.inputs.error = null;

      }

    }

    /**
     * Checks if a schedule is not in collision with other schedules.
     *
     * Group&#x27;s schedule should not be in collision with devices&#x27; schedule inside the group.
     *
     * @method isValidSchedule
     * @param {String} id The group id
     * @param {Object} schedule The schedule to validate
     * @return {Error|Null} The error if validation failed, null otherwise
     */
    function isValidSchedule(id, schedule) {
      var group = getGroup(id);

      if (group) {
        var validationError = ManageableFactory.isValidSchedule(schedule, group.schedules);
        if (validationError) return validationError;

        var devicesInConflict = [];

        // Validates that the new schedule is not in conflict with one of the
        // schedules in group&#x27;s devices
        for (var i = 0; i &lt; group.devices.length; i++) {
          var device = group.devices[i];
          var isConflict = false;

          for (var j = 0; j &lt; device.schedules.length; j++) {
            if (ManageableFactory.checkSchedulesConflict(device.schedules[j], schedule)) {
              isConflict = true;
              break;
            }
          }

          if (isConflict)
            devicesInConflict.push($filter(&#x27;translate&#x27;)(device.name));

        }

        if (devicesInConflict.length) {
          return new Error($filter(&#x27;translate&#x27;)(&#x27;MANAGE.MANAGEABLE.GROUP_DEVICES_CONFLICT_ERROR&#x27;, null, {
            devices: devicesInConflict.join(&#x27;, &#x27;)
          }));
        }
      }

      return null;
    }

    return {
      getGroups: getGroups,
      addDevices: addDevices,
      getGroup: getGroup,
      addGroup: addGroup,
      removeGroup: removeGroup,
      setGroupsProperty: setGroupsProperty,
      setProperty: setProperty,
      addDeviceToGroup: addDeviceToGroup,
      removeDeviceFromGroup: removeDeviceFromGroup,
      addHistoric: addHistoric,
      addSchedule: addSchedule,
      removeHistoric: removeHistoric,
      removeHistory: removeHistory,
      removeSchedule: removeSchedule,
      updateStatus: updateStatus,
      validatePreset: validatePreset,
      isValidSchedule: isValidSchedule
    };

  }

  app.factory(&#x27;ManageGroupFactory&#x27;, GroupFactory);
  GroupFactory.$inject = [
    &#x27;$q&#x27;,
    &#x27;$rootScope&#x27;,
    &#x27;$timeout&#x27;,
    &#x27;$filter&#x27;,
    &#x27;MANAGE_DEVICE_STATUS&#x27;,
    &#x27;MANAGE_MANAGEABLE_TYPES&#x27;,
    &#x27;ManageDeviceFactory&#x27;,
    &#x27;ManageFactory&#x27;,
    &#x27;ManageManageableFactory&#x27;
  ];

})(angular.module(&#x27;ov.manage&#x27;));

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
