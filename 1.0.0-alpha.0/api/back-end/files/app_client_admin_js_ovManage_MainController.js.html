<!DOCTYPE html>
<html lang="en" class="yui-overrride">
<head>
    <meta charset="utf-8">
    <title>app/client/admin/js/ovManage/MainController.js - OpenVeo Manage AngularJS back end</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1 class="blue-main-title">OpenVeo Manage AngularJS back end</h1>
        </div>
        <div class="yui3-u-1-4 version project-version">
            API Docs for: 1.0.0-alpha.0
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/GroupFactory.html">GroupFactory</a></li>
                                <li><a href="../classes/ManageDeviceFactory.html">ManageDeviceFactory</a></li>
                                <li><a href="../classes/ManageFactory.html">ManageFactory</a></li>
                                <li><a href="../classes/ManageManageableFactory.html">ManageManageableFactory</a></li>
                                <li><a href="../classes/ManageSocketService.html">ManageSocketService</a></li>
                                <li><a href="../classes/ovManageSortTable.html">ovManageSortTable</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ov.manage.html">ov.manage</a></li>
                                <li><a href="../modules/ov.manage.socketIO.html">ov.manage.socketIO</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app/client/admin/js/ovManage/MainController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

(function(app) {

  /**
   * Defines the manage controller
   */
  function MainController(
    $q,
    $scope,
    $window,
    $location,
    $filter,
    $route,
    $rootScope,
    $timeout,
    devices,
    groups,
    ManageFactory,
    GroupFactory,
    DeviceFactory,
    SocketService,
    entityService,
    MANAGE_NAME,
    DEVICE_STATES,
    DEVICE_STATUS,
    MANAGEABLE_TYPES) {

    var devicesIds = [],
      activePage = 0,
      group = GroupFactory.getGroup($route.current.params.id);

    // Add devices to groups
    GroupFactory.addDevices(devices[DEVICE_STATES.ACCEPTED]);

    // Initialize data
    if (group) {
      $scope.group = group;
      $scope.acceptedDevices = group.devices;
    } else {
      $scope.acceptedDevices = devices[DEVICE_STATES.ACCEPTED];
    }

    $scope.DEVICE_STATES = DEVICE_STATES;
    $scope.DEVICE_STATUS = DEVICE_STATUS;
    $scope.MANAGEABLE_TYPES = MANAGEABLE_TYPES;
    $scope.groups = groups;
    $scope.refusedDevices = devices[DEVICE_STATES.REFUSED];
    $scope.pendingDevices = devices[DEVICE_STATES.PENDING];
    $scope.manage = {
      resize: &#x27;normal&#x27;, // Permits to resize the devices tiles (normal/medium/small)
      openedItem: null, // Contain the id of the selected device
      showDetail: false, // Used to add a class to the selected device
      absUrl: $location.absUrl() // The URL of the current page
    };

    $scope.incomingDevices = DeviceFactory.getDevicesByState(DEVICE_STATES.INCOMING); // The new incoming devices

    // Initialize socket.io connection
    if (!$scope.socket) {
      $scope.socket = SocketService.initSocket();

      // Listen for the server informing about a new connected device with :
      //   - **Object** device The new connected device information
      $scope.socket.on(&#x27;device.connect&#x27;, function(device) {
        if (device) {
          DeviceFactory.addDevice(device, DEVICE_STATES.PENDING);
          $scope.$apply();
        }
      });

      // Listen for the server requesting a manageable to be removed with :
      //   - **Object** date Data from server with :
      //     - **String** id The manageable id
      //     - **String** type The manageable type
      $scope.socket.on(&#x27;remove&#x27;, function(data) {
        if (data.type === MANAGEABLE_TYPES.DEVICE) {
          var device = DeviceFactory.getDevice(data.id);

          // Remove device from its group
          if (device &amp;&amp; device.group) {
            var group = GroupFactory.getGroup(device.group);
            GroupFactory.removeDeviceFromGroup(device, device.group);

            if (!group.devices.length)
              GroupFactory.removeGroup(device.group);
          }

          DeviceFactory.remove(data.id);
          $scope.$broadcast(&#x27;manageable.closeDetails&#x27;);
        } else if (data.type === MANAGEABLE_TYPES.GROUP) {
          GroupFactory.removeGroup(data.id);

          // Navigate back if we are in a group page
          if ($route.current.params.id)
            $scope.$broadcast(&#x27;back&#x27;);
          else
            $scope.$broadcast(&#x27;manageable.closeDetails&#x27;);
        }
      });

      // Listen for server requesting a modification on a manageable :
      //   - **Object** data Data from server with :
      //     - **String** id The manageable id
      //     - **String** key The property to update
      //     - **Mixed** value The property value
      //     - **String** type The manageable type
      $scope.socket.on(&#x27;update&#x27;, function(data) {
        if (data.type === MANAGEABLE_TYPES.DEVICE) {
          var device = DeviceFactory.getDevice(data.id);
          DeviceFactory.setProperty(data.id, data.key, data.value);
          GroupFactory.updateStatus(device.group);
        } else
          GroupFactory.setProperty(data.id, data.key, data.value);

        $scope.$apply();
      });

      // Listen for server requesting an historic to be added to the history of a manageable with :
      //   - **Object** data Data from server with :
      //     - **String** id The manageable id
      //     - **Object** historic The historic to add to history
      //     - **String** type The manageable type
      $scope.socket.on(&#x27;addHistoric&#x27;, function(data) {
        var factory = (data.type === MANAGEABLE_TYPES.DEVICE) ? DeviceFactory : GroupFactory;
        factory.addHistoric(data.id, data.historic);
        $scope.$apply();
      });

      // Listen for server requesting an historic to be removed from the history of a manageable with :
      //   - **Object** data Data from server with :
      //     - **String** id The manageable id
      //     - **Object** historicId The historic id
      //     - **String** type The manageable type
      $scope.socket.on(&#x27;removeHistoric&#x27;, function(data) {
        var factory = (data.type === MANAGEABLE_TYPES.DEVICE) ? DeviceFactory : GroupFactory;
        factory.removeHistoric(data.id, data.historicId);
        $scope.$apply();
      });

      // Listen for server requesting a manageable&#x27;s history to be removed with :
      //   - **Object** data Data from server with :
      //     - **String** id The manageable id
      //     - **String** type The manageable type
      $scope.socket.on(&#x27;removeHistory&#x27;, function(data) {
        var factory = (data.type === MANAGEABLE_TYPES.DEVICE) ? DeviceFactory : GroupFactory;
        factory.removeHistory(data.id);
        $scope.$apply();
      });

      // Listen for server requesting a schedule to be added to a manageable with :
      //   - **Object** data Data from server with :
      //     - **String** id The manageable id
      //     - **Object** schedule The schedule
      //     - **String** type The manageable type
      $scope.socket.on(&#x27;addSchedule&#x27;, function(data) {
        var factory = (data.type === MANAGEABLE_TYPES.DEVICE) ? DeviceFactory : GroupFactory;
        factory.addSchedule(data.id, data.schedule);
        $scope.$apply();
      });

      // Listen for server requesting a schedule to be removed from a manageable with :
      //   - **Object** data Data from server with :
      //     - **String** id The manageable id
      //     - **Object** scheduleId The schedule id
      //     - **String** type The manageable type
      $scope.socket.on(&#x27;removeSchedule&#x27;, function(data) {
        var factory = (data.type === MANAGEABLE_TYPES.DEVICE) ? DeviceFactory : GroupFactory;
        factory.removeSchedule(data.id, data.scheduleId);
        $scope.$apply();
      });

      // Listen for server requesting state modification on a device :
      //   - **Object** data Data from server with :
      //     - **String** id The device id
      //     - **String** state The device new state
      $scope.socket.on(&#x27;device.updateState&#x27;, function(data) {
        DeviceFactory.updateDeviceState(data.id, data.state);
        $scope.$apply();
      });

      // Listen for server requesting a group to be created :
      //   - **Object** data Data from server with :
      //     - **Object** group The group to add
      $scope.socket.on(&#x27;group.create&#x27;, function(data) {
        if (data.group)
          GroupFactory.addGroup(data.group);
      });

      // Listen for server requesting a device to be added to a group :
      //   - **Object** data Data from server with :
      //     - **String** deviceId The device id
      //     - **String** groupId The group id
      $scope.socket.on(&#x27;group.addDevice&#x27;, function(data) {
        if (data.deviceId &amp;&amp; data.groupId) {
          GroupFactory.addDeviceToGroup(DeviceFactory.getDevice(data.deviceId), data.groupId);

          // Send an event to close the device detail window
          $timeout(function() {
            $rootScope.$broadcast(&#x27;manageable.closeDetails&#x27;);
          }, 250);

        }
      });

      // Listen for server requesting a device to be removed from a group :
      //   - **Object** data Data from server with :
      //     - **String** id The device id
      $scope.socket.on(&#x27;group.removeDevice&#x27;, function(data) {
        var device = DeviceFactory.getDevice(data.id);

        if (device) {
          var group = GroupFactory.getGroup(device.group);

          if (group) {

            GroupFactory.removeDeviceFromGroup(device, device.group);

            // Send an event to close the device detail window
            $rootScope.$broadcast(&#x27;manageable.closeDetails&#x27;);

          }

        }

      });
    }

    /**
     * Defines the active page index.
     *
     * @param index The tab index
     */
    $scope.setActivePage = function(index) {
      activePage = index;
    };

    /**
     * Determines if the passed index is the active page index.
     *
     * @param index The tab index
     * @return {Boolean} true if the given index is the selected tab index
     */
    $scope.isActivePage = function(index) {
      return activePage === index;
    };

    /**
     * Permits to organize the view when the details is opened/closed.
     *
     * @param opening
     */
    $scope.organizeLayout = function(opening) {
      var screenWidth = $window.innerWidth,
        containerWidth = parseInt(document.getElementsByClassName(&#x27;manage-container&#x27;)[0].offsetWidth + 30),
        leftSpace = parseInt(screenWidth - containerWidth) / 2;

      if (opening &amp;&amp; leftSpace &lt;= 300) {
        if (containerWidth &lt;= 750) {
          $scope.manage.resize = &#x27;small&#x27;;
        } else {
          $scope.manage.resize = &#x27;medium&#x27;;
        }
      } else {
        $scope.manage.resize = &#x27;normal&#x27;;
      }
    };

    /**
     * Navigates to the previous page in browser&#x27;s history.
     */
    $scope.back = function() {

      // Remove an eventually selected device or group
      $scope.acceptedDevices.forEach(function(device) {
        $rootScope.$broadcast(&#x27;manageable.load&#x27;, device.id, false);
      });
      $scope.groups.forEach(function(group) {
        $rootScope.$broadcast(&#x27;manageable.load&#x27;, group.id, true);
      });
      $scope.manage.showDetail = false;
      $scope.manage.openedItem = null;
      $scope.organizeLayout(false);
      $location.path(&#x27;manage&#x27;);
      $scope.manage.absUrl = $location.absUrl();
    };

    /**
     * Removes a group.
     *
     * @param {String} id The id of the group to remove
     */
    $scope.removeGroup = function(id) {
      ManageFactory.remove(id, MANAGEABLE_TYPES.GROUP).catch(function(error) {
        $scope.$emit(&#x27;setAlert&#x27;, &#x27;danger&#x27;, $filter(&#x27;translate&#x27;)(&#x27;MANAGE.GROUP.REMOVE_ERROR&#x27;, null, {
          code: error.code
        }), 4000);
      });
    };

    /**
     * Removes a device from its group.
     *
     * @param {String} id The id of the device to remove
     */
    $scope.removeFromGroup = function(id) {
      var device = DeviceFactory.getDevice(id);
      var group = GroupFactory.getGroup(device.group);

      // If there is only 2 devices the group is removed
      if (group.devices.length == 2) {

        // Remove group
        $scope.removeGroup(group.id);

      } else {
        ManageFactory.removeDeviceFromGroup(device.id).then(function() {
          GroupFactory.removeDeviceFromGroup(device.id, device.group);
        }, function(error) {
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;danger&#x27;, $filter(&#x27;translate&#x27;)(&#x27;MANAGE.GROUP.REMOVE_DEVICE_ERROR&#x27;, null, {
            code: error.code,
            name: $filter(&#x27;translate&#x27;)(device.name)
          }), 4000);
        });
      }
    };

    // Asks for devices settings only once
    if (!devicesIds.length) {
      $scope.acceptedDevices.forEach(function(device) {
        devicesIds.push(device.id);
      });

      if (devicesIds.length)
        ManageFactory.askForDevicesSettings(devicesIds);
    }
  }

  app.controller(&#x27;ManageMainController&#x27;, MainController);
  MainController.$inject = [
    &#x27;$q&#x27;,
    &#x27;$scope&#x27;,
    &#x27;$window&#x27;,
    &#x27;$location&#x27;,
    &#x27;$filter&#x27;,
    &#x27;$route&#x27;,
    &#x27;$rootScope&#x27;,
    &#x27;$timeout&#x27;,
    &#x27;manageDevices&#x27;,
    &#x27;manageGroups&#x27;,
    &#x27;ManageFactory&#x27;,
    &#x27;ManageGroupFactory&#x27;,
    &#x27;ManageDeviceFactory&#x27;,
    &#x27;ManageSocketService&#x27;,
    &#x27;entityService&#x27;,
    &#x27;MANAGE_NAME&#x27;,
    &#x27;MANAGE_DEVICE_STATES&#x27;,
    &#x27;MANAGE_DEVICE_STATUS&#x27;,
    &#x27;MANAGE_MANAGEABLE_TYPES&#x27;
  ];

})(angular.module(&#x27;ov.manage&#x27;));

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
