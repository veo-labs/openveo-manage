<!DOCTYPE html>
<html lang="en" class="yui-overrride">
<head>
    <meta charset="utf-8">
    <title>app/client/admin/js/ovManage/ManageableFactory.js - OpenVeo Manage AngularJS back end</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1 class="blue-main-title">OpenVeo Manage AngularJS back end</h1>
        </div>
        <div class="yui3-u-1-4 version project-version">
            API Docs for: 1.0.0-alpha.1
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/GroupFactory.html">GroupFactory</a></li>
                                <li><a href="../classes/ManageDeviceFactory.html">ManageDeviceFactory</a></li>
                                <li><a href="../classes/ManageFactory.html">ManageFactory</a></li>
                                <li><a href="../classes/ManageManageableFactory.html">ManageManageableFactory</a></li>
                                <li><a href="../classes/ManageSocketService.html">ManageSocketService</a></li>
                                <li><a href="../classes/ovManageSortTable.html">ovManageSortTable</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ov.manage.html">ov.manage</a></li>
                                <li><a href="../modules/ov.manage.socketIO.html">ov.manage.socketIO</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app/client/admin/js/ovManage/ManageableFactory.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

(function(app) {

  /**
   * Defines a factory to manage manageables.
   *
   * @module ov.manage
   * @class ManageManageableFactory
   */
  function ManageableFactory($filter) {

    /**
     * Checks if two schedules are in conflict.
     *
     * @method checkSchedulesConflict
     * @private
     * @param {Object} schedule1 Schedule object with :
     *   - **Date** beginDate : The begin date of the schedule
     *   - **Date** duration : The schedule duration
     *   - **Boolean** recurrent : true is this is a daily schedule, false otherwise
     * @param {Object} schedule2 Schedule object with :
     *   - **Date** beginDate : The begin date of the schedule
     *   - **Date** duration : The schedule duration
     *   - **Boolean** recurrent : true is this is a daily schedule, false otherwise
     * @return {Boolean} true if there are in conflict, false otherwise
     */
    function checkSchedulesConflict(schedule1, schedule2) {
      var schedule1DateTimeBegin = new Date(schedule1.beginDate);
      var schedule1DateDailyEnd = new Date(schedule1.endDate);
      var schedule1DateTimeEnd = new Date(schedule1DateTimeBegin.getTime() + schedule1.duration);
      var schedule2DateTimeBegin = new Date(schedule2.beginDate);
      var schedule2DateDailyEnd = new Date(schedule2.endDate);
      var schedule2DateTimeEnd = new Date(schedule2DateTimeBegin.getTime() + schedule2.duration);

      if ((schedule2DateTimeBegin &gt;= schedule1DateTimeBegin &amp;&amp; schedule2DateTimeBegin &lt;= schedule1DateTimeEnd) ||
        (schedule2DateTimeEnd &gt;= schedule1DateTimeBegin &amp;&amp; schedule2DateTimeEnd &lt;= schedule1DateTimeEnd) ||
        (schedule2DateTimeBegin &lt;= schedule1DateTimeBegin &amp;&amp; schedule2DateTimeEnd &gt;= schedule1DateTimeEnd)) {

        // Conflict between schedules&#x27; dates :

        // Schedule2 start date is in schedule1 date interval
        // schedule1 : [------------]
        // schedule2 :   [------------]

        // schedule1 : [------------]
        // schedule2 :   [--------]

        // Schedule2 end date is in schedule1 date interval
        // schedule1 :   [------------]
        // schedule2 : [------------]

        // Schedule2 date interval cover the schedule1 date interval
        // schedule1 :   [------------]
        // schedule2 : [----------------]

        return true;
      }

      if (((schedule2DateTimeBegin &gt;= schedule1DateTimeBegin &amp;&amp; schedule2DateTimeBegin &lt;= schedule1DateDailyEnd) ||
        (schedule2DateDailyEnd &gt;= schedule1DateTimeBegin &amp;&amp; schedule2DateDailyEnd &lt;= schedule1DateDailyEnd) ||
        (schedule2DateTimeBegin &lt;= schedule1DateTimeBegin &amp;&amp; schedule2DateDailyEnd &gt;= schedule1DateDailyEnd)) &amp;&amp;
         (schedule1.recurrent || schedule2.recurrent)) {

        // Daily schedule with conflicting dates
        // Compare only time

        var schedule1TimeBegin = schedule1DateTimeBegin.getHours() + &#x27;:&#x27; + schedule1DateTimeBegin.getMinutes();
        var schedule1TimeEnd = schedule1DateTimeEnd.getHours() + &#x27;:&#x27; + schedule1DateTimeEnd.getMinutes();
        var schedule2TimeBegin = schedule2DateTimeBegin.getHours() + &#x27;:&#x27; + schedule2DateTimeBegin.getMinutes();
        var schedule2TimeEnd = schedule2DateTimeEnd.getHours() + &#x27;:&#x27; + schedule2DateTimeEnd.getMinutes();

        if ((schedule2TimeBegin &gt;= schedule1TimeBegin &amp;&amp; schedule2TimeBegin &lt;= schedule1TimeEnd) ||
          (schedule2TimeEnd &gt;= schedule1TimeBegin &amp;&amp; schedule2TimeEnd &lt;= schedule1TimeEnd) ||
          (schedule2TimeBegin &lt;= schedule1TimeBegin &amp;&amp; schedule2TimeEnd &gt;= schedule1TimeEnd)) {

          // Conflict between schedules&#x27; times :

          // Schedule2 start time is in schedule1 time interval
          // schedule1 : [------------]
          // schedule2 :   [------------]

          // schedule1 : [------------]
          // schedule2 :   [--------]

          // Schedule2 end time is in schedule1 time interval
          // schedule1 :   [------------]
          // schedule2 : [------------]

          // Schedule2 time interval cover the schedule1 time interval
          // schedule1 :   [------------]
          // schedule2 : [----------------]

          return true;
        }
      }

      return false;
    }

    /**
     * Adds a manageable historic.
     *
     * @method addHistoric
     * @param {Object} manageable The manageable
     * @param {Object} historic The historic to add
     */
    function addHistoric(manageable, historic) {
      if (manageable) {

        if (historic.message.params &amp;&amp; historic.message.params.groupName)
          historic.message.params.groupName = $filter(&#x27;translate&#x27;)(historic.message.params.groupName);

        // Make sure historic does not already exist
        var found = false;
        for (var i = 0; i &lt; manageable.history.length; i++) {
          if (manageable.history[i].id === historic.id) {
            found = true;
            break;
          }
        }

        if (!found)
          manageable.history.push(historic);
      }
    }

    /**
     * Removes a manageable historic.
     *
     * @method removeHistoric
     * @param {Object} manageable The manageable
     * @param {String} historicId The historic id
     */
    function removeHistoric(manageable, historicId) {
      if (manageable) {
        var index = -1;
        for (var i = 0; i &lt; manageable.history.length; i++) {
          if (manageable.history[i].id === historicId) {
            index = i;
            break;
          }
        }

        if (index &gt; -1)
          manageable.history.splice(index, 1);
      }
    }

    /**
     * Removes a manageable&#x27;s history.
     *
     * @method removeHistory
     * @param {Object} manageable The manageable
     */
    function removeHistory(manageable) {
      if (manageable)
        manageable.history.splice(0, manageable.history.length);
    }

    /**
     * Adds a manageable schedule.
     *
     * @method addSchedule
     * @param {Object} manageable The manageable
     * @param {Object} schedule The schedule
     */
    function addSchedule(manageable, schedule) {
      if (manageable) {

        // Make sure schedule does not already exist
        var found = false;
        for (var i = 0; i &lt; manageable.schedules.length; i++) {
          if (manageable.schedules[i].id === schedule.id) {
            found = true;
            break;
          }
        }

        if (!found)
          manageable.schedules.push(schedule);
      }
    }

    /**
     * Removes a manageable&#x27;s schedule.
     *
     * @method removeSchedule
     * @param {Object} manageable The manageable
     * @param {String} scheduleId The schedule id
     */
    function removeSchedule(manageable, scheduleId) {
      if (manageable) {
        var index = -1;
        for (var i = 0; i &lt; manageable.schedules.length; i++) {
          if (manageable.schedules[i].id === scheduleId) {
            index = i;
            break;
          }
        }

        if (index &gt; -1)
          manageable.schedules.splice(index, 1);
      }
    }

    /**
     * Gets a manageable&#x27;s preset.
     *
     * @method getPreset
     * @param {Object} manageable The manageable
     * @param {String} presetId The manageable&#x27;s preset to look for
     * @return {Object|Null} The preset&#x27;s configuration or null if not found
     */
    function getPreset(manageable, presetId) {
      if (manageable &amp;&amp; presetId) {
        for (var i = 0; i &lt; manageable.presets.length; i++) {
          if (manageable.presets[i].id === presetId)
            return manageable.presets[i];
        }
      }

      return null;
    }

    /**
     * Checks if a schedule is not in collision with other schedules.
     *
     * @method isValidSchedule
     * @param {Object} schedule The schedule to validate
     * @param {Array} schedules The list of schedules
     * @return {Error|Null} The error if validation failed, null otherwise
     */
    function isValidSchedule(schedule, schedules) {

      // Start date is after end date
      if (schedule.beginDate &gt;= schedule.endDate)
        return new Error($filter(&#x27;translate&#x27;)(&#x27;MANAGE.MANAGEABLE.BEGIN_END_DATES_ERROR&#x27;));

      // Start date is before actual date
      if (schedule.beginDate &lt;= new Date())
        return new Error($filter(&#x27;translate&#x27;)(&#x27;MANAGE.MANAGEABLE.BEGIN_DATE_ERROR&#x27;));

      if (schedules) {

        // Validates that the schedule is not in conflict with one of the schedules
        for (var i = 0; i &lt; schedules.length; i++) {
          if (checkSchedulesConflict(schedules[i], schedule))
            return new Error($filter(&#x27;translate&#x27;)(&#x27;MANAGE.MANAGEABLE.CONFLICT_ERROR&#x27;));
        }

      }

      return null;
    }

    return {
      addHistoric: addHistoric,
      removeHistoric: removeHistoric,
      removeHistory: removeHistory,
      addSchedule: addSchedule,
      removeSchedule: removeSchedule,
      getPreset: getPreset,
      checkSchedulesConflict: checkSchedulesConflict,
      isValidSchedule: isValidSchedule
    };

  }

  app.factory(&#x27;ManageManageableFactory&#x27;, ManageableFactory);
  ManageableFactory.$inject = [
    &#x27;$filter&#x27;
  ];

})(angular.module(&#x27;ov.manage&#x27;));

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
